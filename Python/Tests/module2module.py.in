#!/usr/bin/env python

import sys
sys.path.insert(0, "@PYTHON_TEST_PYTHON_PATH@")

import os
env_lib_name = "LD_LIBRARY_PATH"
if os.environ.has_key(env_lib_name) :
  os.environ[env_lib_name] = "@PYTHON_TEST_LIB_PATH@:%s" % os.environ[env_lib_name]
else:
  os.environ[env_lib_name] = "@PYTHON_TEST_LIB_PATH@"




import itk, sys

import ITKCommonA
import ITKCommonB
import ITKNumerics
import ITKBasicFiltersA
import ITKBasicFiltersB
import ITKBasicFiltersC
import ITKSpatialObject
import ITKAlgorithms
import ITKIO

PType = itk.US
dim = 2
IType = itk.Image[PType, dim]

# create the reader
reader = itk.ImageFileReader[IType].New(FileName=sys.argv[1])

sources = []
image = ITKCommonA.Image[PType, dim].New()
r = itk.ImageRegion._2()
r.SetSize((10, 10))
image.SetRegions(r)
image.Allocate()

sources.append(("ITKCommonA", image))

flip = ITKBasicFiltersA.FlipImageFilter[IType].New(reader)
sources.append(("ITKBasicFiltersA", flip.GetOutput()))

shift = ITKBasicFiltersB.ShiftScaleImageFilter[IType, IType].New(reader)
sources.append(("ITKBasicFiltersB", shift.GetOutput()))

abs = ITKBasicFiltersC.AbsImageFilter[IType, IType].New(reader)
sources.append(("ITKBasicFiltersC", abs.GetOutput()))

otsu = ITKAlgorithms.OtsuThresholdImageFilter[IType, IType].New(reader)
sources.append(("ITKAlgorithms", otsu.GetOutput()))

sources.append(("ITKIO", reader.GetOutput()))



dests = []
dflip = ITKBasicFiltersA.FlipImageFilter[IType].New()
dests.append(("ITKBasicFiltersA", dflip))

dshift = ITKBasicFiltersB.ShiftScaleImageFilter[IType, IType].New()
dests.append(("ITKBasicFiltersB", dshift))

dabs = ITKBasicFiltersC.AbsImageFilter[IType, IType].New()
dests.append(("ITKBasicFiltersC", dabs))

dotsu = ITKAlgorithms.OtsuThresholdImageFilter[IType, IType].New()
dests.append(("ITKAlgorithms", dotsu))

writer = ITKIO.ImageFileWriter[IType].New(FileName='out.png')
dests.append(("ITKIO", writer))


nb = 0
failList = []
for sname, s in sources:
  for dname, d in dests:
    nb += 1
    d.SetInput( s )
    try:
      d.Update()
      print "%s -> %s pass" % (sname, dname)
    except RuntimeError, e:
      print "%s -> %s fail" % (sname, dname)
      failList.append((sname, dname))
      
      
print
print "%i tests succeed" % (nb - len(failList))
print "%i tests failed" % len(failList)

sys.exit(len(failList))